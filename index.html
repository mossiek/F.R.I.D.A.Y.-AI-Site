<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FRIDAY ‚Äî Standalone (Text & Voice)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: dark; }
    html,body { height:100%; }
    .glass { background: rgba(20,20,28,0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.08); }
    .scrollbar::-webkit-scrollbar { width: 10px; }
    .scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.12); border-radius: 9999px; }
    .pulse { box-shadow: 0 0 0 0 rgba(59,130,246,0.7); animation: pulse 1.8s infinite; }
    @keyframes pulse { 0% { box-shadow:0 0 0 0 rgba(59,130,246,0.7); } 70% { box-shadow:0 0 0 20px rgba(59,130,246,0); } 100% { box-shadow:0 0 0 0 rgba(59,130,246,0); } }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-800 text-slate-100">
  <div class="mx-auto max-w-3xl px-4 py-10 min-h-screen flex flex-col">
    <header class="mb-6 flex items-center gap-3">
      <div class="h-12 w-12 rounded-2xl glass grid place-items-center font-black text-xl select-none">F</div>
      <div>
        <h1 class="text-2xl font-semibold tracking-tight">FRIDAY ‚Äî Standalone Web App</h1>
        <p class="text-slate-400 text-sm">Type or say ‚ÄúHey Friday ‚Ä¶‚Äù. It will reply in text and voice.</p>
      </div>
      <div class="ml-auto flex items-center gap-4 text-sm">
        <label class="flex items-center gap-2"><input id="toggleWake" type="checkbox" class="accent-blue-500" checked> Wake word</label>
        <label class="flex items-center gap-2"><input id="toggleTTS" type="checkbox" class="accent-blue-500" checked> Speak replies</label>
      </div>
    </header>

    <main class="glass rounded-3xl p-4 flex-1 flex flex-col">
      <div id="log" class="scrollbar flex-1 overflow-y-auto space-y-3 p-2 rounded-2xl border border-white/10">
        <!-- Messages get appended here -->
      </div>

      <form id="composer" class="mt-4 flex items-center gap-2" autocomplete="off">
        <input id="text" class="flex-1 rounded-2xl border border-slate-700 bg-slate-900/60 px-4 py-3 outline-none focus:ring-2 focus:ring-blue-600" placeholder="Type a message‚Ä¶ (or say ‚ÄòHey Friday‚Äô)" />
        <button type="button" id="micBtn" title="Click once to arm the mic (wake‚Äëword). Click again for push‚Äëto‚Äëtalk." class="rounded-2xl px-4 py-3 glass border border-slate-700 hover:border-blue-500 transition select-none">üéôÔ∏è</button>
        <button class="rounded-2xl px-4 py-3 bg-blue-600 hover:bg-blue-500 transition">Send</button>
      </form>

      <div class="mt-3 text-xs text-slate-500 flex items-center gap-3">
        <span id="status">Mic idle</span>
        <span>¬∑</span>
        <span class="hidden md:inline">Tip: HTTPS is required for mic on most browsers. Click the mic once to grant permission.</span>
      </div>
    </main>

    <footer class="mt-6 text-center text-xs text-slate-500">
      Browser Speech‚Äëto‚ÄëText/Text‚Äëto‚ÄëSpeech by default. Swap in server STT/TTS later (ElevenLabs, OpenAI Realtime, Vosk, etc.).
    </footer>
  </div>

<script>
/***********************
 * 1) CONFIG ‚Äî EDIT ME
 ***********************/
const CONFIG = {
  N8N_WEBHOOK_URL: "https://YOUR_N8N_HOST/webhook/friday", // <- POST endpoint must return { reply: string }
  MODEL_HINT: "You are FRIDAY, Mossie‚Äôs assistant.", // sent as a system hint
  VOICE_NAME: null, // e.g. "Microsoft Zira" | "Google US English" | null for default
  WAKE_WORD: "hey friday",
  AUTO_LISTEN_AFTER_WAKE_MS: 5500, // window for speaking after wake word
};

/***********************
 * 2) UI HELPERS
 ***********************/
const logEl = document.getElementById('log');
const textEl = document.getElementById('text');
const statusEl = document.getElementById('status');
const micBtn = document.getElementById('micBtn');
const toggleWake = document.getElementById('toggleWake');
const toggleTTS = document.getElementById('toggleTTS');

function addMessage(role, text) {
  const wrap = document.createElement('div');
  wrap.className = `flex ${role==='user' ? 'justify-end' : 'justify-start'}`;
  const bubble = document.createElement('div');
  bubble.className = `max-w-[85%] rounded-2xl px-4 py-3 ${role==='user' ? 'bg-blue-600/80' : 'bg-slate-800/80'} border border-white/10 whitespace-pre-wrap`;
  bubble.innerText = text;
  wrap.appendChild(bubble);
  logEl.appendChild(wrap);
  logEl.scrollTop = logEl.scrollHeight;
}

function setStatus(s) { statusEl.textContent = s; }

/***********************
 * 3) TEXT <-> FRIDAY (n8n)
 ***********************/
async function sendTextToFriday(text) {
  const payload = { text, system: CONFIG.MODEL_HINT, sessionId: localStorage.getItem('fridaySession') || crypto.randomUUID() };
  localStorage.setItem('fridaySession', payload.sessionId);
  const res = await fetch(CONFIG.N8N_WEBHOOK_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
  if (!res.ok) throw new Error('FRIDAY webhook error: ' + res.status);
  const data = await res.json();
  return data.reply || '(No reply)';
}

async function handleUserText(text) {
  if (!text) return;
  addMessage('user', text);
  textEl.value = '';
  setStatus('Thinking‚Ä¶');
  try {
    const reply = await sendTextToFriday(text);
    addMessage('assistant', reply);
    speak(reply);
    setStatus('Ready');
  } catch (e) {
    console.error(e);
    addMessage('assistant', '‚ö†Ô∏è Error reaching FRIDAY. Check your webhook URL & CORS.');
    setStatus('Error');
  }
}

/***********************
 * 4) BROWSER TTS (Text ‚Üí Voice)
 ***********************/
function speak(text) {
  if (!toggleTTS.checked) return;
  const u = new SpeechSynthesisUtterance(text);
  if (CONFIG.VOICE_NAME) {
    const v = speechSynthesis.getVoices().find(v=>v.name===CONFIG.VOICE_NAME);
    if (v) u.voice = v;
  }
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}
// Ensure voices are loaded on some browsers
speechSynthesis.onvoiceschanged = () => {};

/***********************
 * 5) BROWSER STT (Voice ‚Üí Text)
 ***********************/
let recognizer = null;
let listening = false;
let wakeArmed = false;
let postWakeTimer = null;

function supportsRecognition() {
  return 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
}

function buildRecognizer() {
  const R = window.SpeechRecognition || window.webkitSpeechRecognition;
  const rec = new R();
  rec.continuous = true;
  rec.interimResults = true;
  rec.lang = navigator.language || 'en-US';
  rec.onstart = () => setStatus('Mic listening‚Ä¶');
  rec.onerror = (e) => setStatus('Mic error: ' + (e.error||'unknown'));
  rec.onend = () => { setStatus('Mic idle'); listening = false; };
  rec.onresult = (ev) => {
    let lastFinal = '';
    for (let i = ev.resultIndex; i < ev.results.length; i++) {
      const r = ev.results[i];
      const t = r[0].transcript.toLowerCase().trim();
      if (r.isFinal) lastFinal = t;
      // Wake word detect from interim or final
      if (toggleWake.checked && wakeArmed && t.includes(CONFIG.WAKE_WORD)) {
        wakeArmed = false; // disarm
        micBtn.classList.add('pulse');
        setStatus('Wake word heard. Speak your request‚Ä¶');
        clearTimeout(postWakeTimer);
        postWakeTimer = setTimeout(() => {
          micBtn.classList.remove('pulse');
          const cleaned = (lastFinal||'').replace(CONFIG.WAKE_WORD, '').trim();
          if (cleaned) handleUserText(cleaned);
          wakeArmed = true; // re-arm for next time
          setStatus('Ready');
        }, CONFIG.AUTO_LISTEN_AFTER_WAKE_MS);
      }
    }
  };
  return rec;
}

function ensureRecognizer() { if (!recognizer) recognizer = buildRecognizer(); }

// Mic button behavior: first click arms continuous wake‚Äëword mode; click again for push‚Äëto‚Äëtalk burst
micBtn.addEventListener('click', async () => {
  if (!supportsRecognition()) {
    alert('Your browser does not support Speech Recognition. Try Chrome or Edge on desktop.');
    return;
  }
  ensureRecognizer();
  if (!listening) {
    recognizer.start();
    listening = true;
    wakeArmed = true;
    setStatus('Listening (wake word armed)‚Ä¶');
  } else {
    // Push‚Äëto‚Äëtalk: capture a short utterance
    wakeArmed = false;
    setStatus('Push‚Äëto‚Äëtalk: speak now‚Ä¶');
    try { recognizer.stop(); } catch {}
    ensureRecognizer();
    const R = window.SpeechRecognition || window.webkitSpeechRecognition;
    const single = new R();
    single.continuous = false;
    single.interimResults = false;
    single.lang = navigator.language || 'en-US';
    single.onresult = (ev)=>{ const t = ev.results[0][0].transcript.trim(); if (t) handleUserText(t); };
    single.onend = ()=>{ setStatus('Listening (wake word armed)‚Ä¶'); wakeArmed = true; try { recognizer.start(); listening = true; } catch {} };
    single.start();
  }
});

/***********************
 * 6) FORM HANDLERS
 ***********************/
const form = document.getElementById('composer');
form.addEventListener('submit', (e) => { e.preventDefault(); handleUserText(textEl.value.trim()); });

/***********************
 * 7) FIRST RUN MESSAGE
 ***********************/
addMessage('assistant', 'Hello! I\'m FRIDAY. Click the mic once to arm wake‚Äëword listening, then say ‚ÄúHey Friday ‚Ä¶‚Äù. Or just type below.');
setStatus('Mic idle');
</script>
</body>
</html>
